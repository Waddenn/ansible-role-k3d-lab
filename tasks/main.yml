---
- name: Verifier la presence de Docker CLI
  ansible.builtin.command: docker --version
  changed_when: false

- name: Verifier l'acces au daemon Docker
  ansible.builtin.command: docker info
  changed_when: false

- name: Creer le dossier des outils locaux
  ansible.builtin.file:
    path: "{{ k3d_tools_dir }}"
    state: directory
    mode: "0755"

- name: Verifier si k3d est disponible dans le PATH
  ansible.builtin.shell: command -v k3d
  register: k3d_in_path
  changed_when: false
  failed_when: false

- name: Installer k3d localement si absent
  ansible.builtin.shell: |
    curl -fsSL https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | USE_SUDO=false K3D_INSTALL_DIR={{ k3d_tools_dir }} bash
  args:
    creates: "{{ k3d_tools_dir }}/k3d"
  when: k3d_in_path.rc != 0

- name: Verifier si kubectl est disponible dans le PATH
  ansible.builtin.shell: command -v kubectl
  register: kubectl_in_path
  changed_when: false
  failed_when: false

- name: Recuperer la version stable de kubectl
  ansible.builtin.uri:
    url: https://dl.k8s.io/release/stable.txt
    return_content: true
  register: kubectl_stable
  changed_when: false
  when: kubectl_in_path.rc != 0

- name: Installer kubectl localement si absent
  ansible.builtin.get_url:
    url: "https://dl.k8s.io/release/{{ kubectl_stable.content | trim }}/bin/linux/amd64/kubectl"
    dest: "{{ k3d_tools_dir }}/kubectl"
    mode: "0755"
  when: kubectl_in_path.rc != 0

- name: Definir les commandes k3d/kubectl effectives
  ansible.builtin.set_fact:
    k3d_cmd: "{{ 'k3d' if k3d_in_path.rc == 0 else (k3d_tools_dir + '/k3d') }}"
    kubectl_cmd: "{{ 'kubectl' if kubectl_in_path.rc == 0 else (k3d_tools_dir + '/kubectl') }}"

- name: Recuperer la liste des clusters k3d en JSON
  ansible.builtin.command: "{{ k3d_cmd }} cluster list -o json"
  register: k3d_clusters_json
  changed_when: false

- name: Creer le cluster k3d (1 serveur, 1 agent)
  ansible.builtin.command: "{{ k3d_cmd }} cluster create {{ k3d_cluster_name }} --servers 1 --agents 1 -p {{ k3d_nodeport }}:{{ k3d_nodeport }}@loadbalancer --wait"
  when: k3d_cluster_name not in (k3d_clusters_json.stdout | from_json | map(attribute='name') | list)

- name: Generer le manifest nginx
  ansible.builtin.template:
    src: nginx.yaml.j2
    dest: "{{ k3d_manifest_path }}"
    mode: "0644"

- name: Ecrire/actualiser le kubeconfig du cluster
  ansible.builtin.command: "{{ k3d_cmd }} kubeconfig write {{ k3d_cluster_name }}"
  register: kubeconfig_write
  changed_when: false

- name: Definir le kubeconfig a utiliser
  ansible.builtin.set_fact:
    kubectl_kubeconfig: "{{ kubeconfig_write.stdout | trim if (kubeconfig_write.stdout | trim | length) > 0 else k3d_kubeconfig_path }}"

- name: Appliquer le manifest kubernetes
  ansible.builtin.command: "{{ kubectl_cmd }} apply -f {{ k3d_manifest_path }}"
  register: kubectl_apply
  changed_when: "' created' in kubectl_apply.stdout or ' configured' in kubectl_apply.stdout"
  environment:
    KUBECONFIG: "{{ kubectl_kubeconfig }}"

- name: Attendre que le deployment nginx soit pret
  ansible.builtin.command: "{{ kubectl_cmd }} rollout status deployment/nginx-custom --timeout=120s"
  changed_when: false
  environment:
    KUBECONFIG: "{{ kubectl_kubeconfig }}"

- name: Afficher l'URL d'acces
  ansible.builtin.debug:
    msg: "Service disponible sur http://localhost:{{ k3d_nodeport }}"
